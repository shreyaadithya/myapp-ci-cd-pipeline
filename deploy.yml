---
- name: Install Tomcat and Deploy Application
  hosts: webservers
  become: yes
  vars:
    tomcat_version: 10.1.30
    tomcat_home: /opt/tomcat
    app_name: myapp

  tasks:
    - name: Debug - Check current directory structure
      shell: |
        ls -la /opt/
        ls -la /opt/tomcat 2>/dev/null || echo "Tomcat not installed"
      register: dir_structure

    - name: Show directory structure
      debug:
        var: dir_structure.stdout

    - name: Update apt cache and install dependencies
      apt:
        update_cache: yes
        name:
          - openjdk-17-jdk
          - wget
        state: present

    - name: Check if Tomcat directory exists
      stat:
        path: "{{ tomcat_home }}"
      register: tomcat_dir

    - name: Show Tomcat directory status
      debug:
        var: tomcat_dir.stat.exists

    - name: Download Tomcat if not exists
      get_url:
        url: "https://dlcdn.apache.org/tomcat/tomcat-10/v{{ tomcat_version }}/bin/apache-tomcat-{{ tomcat_version }}.tar.gz"
        dest: "/tmp/apache-tomcat-{{ tomcat_version }}.tar.gz"
      when: not tomcat_dir.stat.exists

    - name: Extract Tomcat if not exists
      unarchive:
        src: "/tmp/apache-tomcat-{{ tomcat_version }}.tar.gz"
        dest: /opt/
        remote_src: yes
        owner: ubuntu
        group: ubuntu
      when: not tomcat_dir.stat.exists

    - name: Create Tomcat symlink if not exists
      file:
        src: "/opt/apache-tomcat-{{ tomcat_version }}"
        dest: "{{ tomcat_home }}"
        state: link
        force: yes
        owner: ubuntu
        group: ubuntu
      when: not tomcat_dir.stat.exists

    - name: Check if Tomcat was installed successfully
      shell: |
        ls -la "{{ tomcat_home }}"
        ls -la "{{ tomcat_home }}/conf/" 2>/dev/null || echo "Conf directory not found"
      register: tomcat_check

    - name: Show Tomcat installation result
      debug:
        var: tomcat_check.stdout

    - name: Continue with configuration only if Tomcat exists
      block:
        - name: Change Tomcat port to 8081
          replace:
            path: "{{ tomcat_home }}/conf/server.xml"
            regexp: 'port="8080"'
            replace: 'port="8081"'
            backup: yes

        - name: Create Tomcat systemd service file
          copy:
            dest: /etc/systemd/system/tomcat.service
            content: |
              [Unit]
              Description=Apache Tomcat Web Application Container
              After=network.target

              [Service]
              Type=forking
              User=ubuntu
              Group=ubuntu
              Environment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
              Environment=CATALINA_PID={{ tomcat_home }}/temp/tomcat.pid
              Environment=CATALINA_HOME={{ tomcat_home }}
              Environment=CATALINA_BASE={{ tomcat_home }}
              ExecStart={{ tomcat_home }}/bin/startup.sh
              ExecStop={{ tomcat_home }}/bin/shutdown.sh
              Restart=on-failure
              RestartSec=10

              [Install]
              WantedBy=multi-user.target
            owner: root
            group: root
            mode: '0644'

        - name: Set proper permissions on Tomcat directories
          file:
            path: "{{ tomcat_home }}"
            owner: ubuntu
            group: ubuntu
            recurse: yes

        - name: Create Tomcat temp directory
          file:
            path: "{{ tomcat_home }}/temp"
            state: directory
            owner: ubuntu
            group: ubuntu
            mode: '0755'

        - name: Reload systemd daemon
          systemd:
            daemon_reload: yes

        - name: Enable Tomcat service
          systemd:
            name: tomcat
            enabled: yes

        - name: Copy WAR file to Tomcat webapps
          copy:
            src: "myapp.war"
            dest: "{{ tomcat_home }}/webapps/{{ app_name }}.war"
            owner: ubuntu
            group: ubuntu
            mode: '0644'

        - name: Start Tomcat service
          systemd:
            name: tomcat
            state: started

      when: tomcat_dir.stat.exists
